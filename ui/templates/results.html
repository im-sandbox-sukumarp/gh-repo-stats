{% extends "base.html" %}

{% block title %}Results - gh-repo-stats{% endblock %}

{% block content %}
<div class="results-header">
    <div class="results-header-content">
        <h1 class="results-title">
            {% if is_sample %}
                Sample Analysis Results
            {% else %}
                Analysis Results
            {% endif %}
        </h1>
        <p class="results-subtitle">
            {% if is_sample %}
                Demo data showing what analysis results look like
            {% elif job %}
                {{ job.config.organizations|join(', ') }}
            {% endif %}
        </p>
    </div>
    
    <div class="results-actions">
        <button type="button" class="btn btn-secondary" id="copy-results" title="Copy to clipboard">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </svg>
            Copy
        </button>
        <a href="/api/download/{{ job_id }}" class="btn btn-primary" download>
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Download CSV
        </a>
        {% if not is_sample and job_id %}
        <a href="/task/{{ job_id }}" class="btn btn-secondary" title="View script execution output">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="4 17 10 11 4 5"/>
                <line x1="12" y1="19" x2="20" y2="19"/>
            </svg>
            View Output
        </a>
        {% endif %}
        <a href="/" class="btn btn-secondary">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            New Analysis
        </a>
    </div>
</div>

<!-- Summary Cards -->
<section class="summary-section">
    <h2 class="sr-only">Summary Statistics</h2>
    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-icon">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <div class="summary-content">
                <span class="summary-value">{{ summary.total_repos }}</span>
                <span class="summary-label">Total Repositories</span>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-icon">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            </div>
            <div class="summary-content">
                <span class="summary-value">{{ summary.total_size_mb }} MB</span>
                <span class="summary-label">Total Size</span>
            </div>
        </div>
        
        <div class="summary-card {% if summary.repos_with_issues > 0 %}summary-card-warning{% endif %}">
            <div class="summary-icon">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </div>
            <div class="summary-content">
                <span class="summary-value">{{ summary.repos_with_issues }}</span>
                <span class="summary-label">Migration Issues</span>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-icon">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
            </div>
            <div class="summary-content">
                <span class="summary-value">{{ summary.avg_record_count }}</span>
                <span class="summary-label">Avg Record Count</span>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-icon">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="16"/>
                    <line x1="8" y1="12" x2="16" y2="12"/>
                </svg>
            </div>
            <div class="summary-content">
                <span class="summary-value">{{ summary.empty_repos }}</span>
                <span class="summary-label">Empty Repos</span>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-icon">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <line x1="9" y1="3" x2="9" y2="21"/>
                </svg>
            </div>
            <div class="summary-content">
                <span class="summary-value">{{ summary.archived_repos }}</span>
                <span class="summary-label">Archived Repos</span>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-icon">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="18" r="3"/>
                    <circle cx="6" cy="6" r="3"/>
                    <circle cx="18" cy="6" r="3"/>
                    <path d="M18 9a9 9 0 0 1-9 9"/>
                    <path d="M6 9a9 9 0 0 0 9 9"/>
                </svg>
            </div>
            <div class="summary-content">
                <span class="summary-value">{{ summary.forked_repos }}</span>
                <span class="summary-label">Forked Repos</span>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-icon">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="4"/>
                    <line x1="1.05" y1="12" x2="7" y2="12"/>
                    <line x1="17.01" y1="12" x2="22.96" y2="12"/>
                </svg>
            </div>
            <div class="summary-content">
                <span class="summary-value">{{ summary.total_prs }}</span>
                <span class="summary-label">Total PRs</span>
            </div>
        </div>
    </div>
</section>

<!-- Data Table -->
<section class="table-section">
    <div class="table-toolbar">
        <div class="search-box">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <input type="search" id="table-search" class="search-input" placeholder="Search repositories..." aria-label="Search repositories">
        </div>
        
        <div class="table-filters">
            <select id="filter-status" class="form-input form-select filter-select" aria-label="Filter by status">
                <option value="">All Repos</option>
                <option value="migration-issue">Migration Issues</option>
                <option value="empty">Empty</option>
                <option value="archived">Archived</option>
                <option value="forked">Forked</option>
            </select>
        </div>
    </div>
    
    <div class="table-wrapper">
        <div class="table-container">
            <table class="data-table" id="results-table">
                <thead>
                    <tr>
                        <th class="sortable sticky-col" data-sort="Org_Name">Org_Name</th>
                        <th class="sortable sticky-col-2" data-sort="Repo_Name">Repo_Name</th>
                        <th class="sortable text-center" data-sort="Is_Empty">Is_Empty</th>
                        <th class="sortable" data-sort="Last_Push">Last_Push</th>
                        <th class="sortable" data-sort="Last_Update">Last_Update</th>
                        <th class="sortable text-center" data-sort="isFork">isFork</th>
                        <th class="sortable text-center" data-sort="isArchived">isArchived</th>
                        <th class="sortable text-right" data-sort="Repo_Size(mb)">Repo_Size(mb)</th>
                        <th class="sortable text-right" data-sort="Record_Count">Record_Count</th>
                        <th class="sortable text-right" data-sort="Collaborator_Count">Collaborator_Count</th>
                        <th class="sortable text-right" data-sort="Protected_Branch_Count">Protected_Branch_Count</th>
                        <th class="sortable text-right" data-sort="PR_Review_Count">PR_Review_Count</th>
                        <th class="sortable text-right" data-sort="Milestone_Count">Milestone_Count</th>
                        <th class="sortable text-right" data-sort="Issue_Count">Issue_Count</th>
                        <th class="sortable text-right" data-sort="PR_Count">PR_Count</th>
                        <th class="sortable text-right" data-sort="PR_Review_Comment_Count">PR_Review_Comment_Count</th>
                        <th class="sortable text-right" data-sort="Commit_Comment_Count">Commit_Comment_Count</th>
                        <th class="sortable text-right" data-sort="Issue_Comment_Count">Issue_Comment_Count</th>
                        <th class="sortable text-right" data-sort="Issue_Event_Count">Issue_Event_Count</th>
                        <th class="sortable text-right" data-sort="Release_Count">Release_Count</th>
                        <th class="sortable text-right" data-sort="Project_Count">Project_Count</th>
                        <th class="sortable text-right" data-sort="Branch_Count">Branch_Count</th>
                        <th class="sortable text-right" data-sort="Tag_Count">Tag_Count</th>
                        <th class="sortable text-right" data-sort="Discussion_Count">Discussion_Count</th>
                        <th class="sortable text-center" data-sort="Has_Wiki">Has_Wiki</th>
                        <th class="sortable" data-sort="Full_URL">Full_URL</th>
                        <th class="sortable text-center" data-sort="Migration_Issue">Migration_Issue</th>
                        <th class="sortable" data-sort="Created">Created</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in results %}
                    <tr class="{% if row.Migration_Issue == 'TRUE' or row.Migration_Issue == true %}row-warning{% endif %}"
                        data-org="{{ row.Org_Name }}"
                        data-repo="{{ row.Repo_Name }}"
                        data-empty="{{ row.Is_Empty|string|lower }}"
                        data-fork="{{ row.isFork|string|lower }}"
                        data-archived="{{ row.isArchived|string|lower }}"
                        data-migration="{{ row.Migration_Issue|string|lower }}">
                        <td class="sticky-col">{{ row.Org_Name }}</td>
                        <td class="sticky-col-2">
                            <a href="{{ row.Full_URL }}" target="_blank" rel="noopener noreferrer" class="repo-link">{{ row.Repo_Name }}</a>
                            {% if row.isFork %}<span class="badge badge-fork">Fork</span>{% endif %}
                        </td>
                        <td class="text-center">
                            {% if row.Is_Empty %}<span class="status-yes">✓</span>{% else %}<span class="status-no">—</span>{% endif %}
                        </td>
                        <td class="cell-timestamp">{{ row.Last_Push if row.Last_Push else '—' }}</td>
                        <td class="cell-timestamp">{{ row.Last_Update if row.Last_Update else '—' }}</td>
                        <td class="text-center">
                            {% if row.isFork %}<span class="status-yes">✓</span>{% else %}<span class="status-no">—</span>{% endif %}
                        </td>
                        <td class="text-center">
                            {% if row.isArchived %}<span class="status-yes">✓</span>{% else %}<span class="status-no">—</span>{% endif %}
                        </td>
                        <td class="text-right cell-number">{{ row['Repo_Size(mb)']|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Record_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Collaborator_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Protected_Branch_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.PR_Review_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Milestone_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Issue_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.PR_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.PR_Review_Comment_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Commit_Comment_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Issue_Comment_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Issue_Event_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Release_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Project_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Branch_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Tag_Count|default(0) }}</td>
                        <td class="text-right cell-number">{{ row.Discussion_Count|default(0) }}</td>
                        <td class="text-center">
                            {% if row.Has_Wiki %}<span class="status-yes">✓</span>{% else %}<span class="status-no">—</span>{% endif %}
                        </td>
                        <td class="cell-url">
                            <a href="{{ row.Full_URL }}" target="_blank" rel="noopener noreferrer">{{ row.Full_URL }}</a>
                        </td>
                        <td class="text-center">
                            {% if row.Migration_Issue == 'TRUE' or row.Migration_Issue == true %}
                            <span class="status-danger">✓</span>
                            {% else %}
                            <span class="status-ok">✓</span>
                            {% endif %}
                        </td>
                        <td class="cell-timestamp">{{ row.Created if row.Created else '—' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="table-footer">
        <span class="results-count">
            Showing <strong id="visible-count">{{ results|length }}</strong> of <strong>{{ results|length }}</strong> repositories
        </span>
    </div>
</section>

<!-- Column Selector Modal -->
<div id="column-modal" class="modal" hidden>
    <div class="modal-backdrop"></div>
    <div class="modal-content modal-small" role="dialog" aria-labelledby="column-modal-title" aria-modal="true">
        <div class="modal-header">
            <h2 id="column-modal-title" class="modal-title">Visible Columns</h2>
            <button type="button" class="modal-close" aria-label="Close">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="column-list" id="column-list">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="reset-columns">Reset to Default</button>
            <button type="button" class="btn btn-primary" id="apply-columns">Apply</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Store results data for JavaScript operations
    window.resultsData = {{ results | tojson | safe }};
    
    document.addEventListener('DOMContentLoaded', () => {
        initResultsPage();
    });
</script>
{% endblock %}
